# AI 문서 검증 시스템 v5.2

공공임대 기존주택 매입심사를 위한 AI 기반 문서 자동 검증 시스템

## ✨ v5.2 주요 개선사항

### 🚦 1. 다중 PDF 처리 안정성 개선 (429 에러 해결)
- **전역 API Rate Limiter** 신설 — 동시 API 호출 최대 3개, 호출 간격 1.2초
- 429 발생 시 전체 쓰레드 30초 쿨다운 (연쇄 429 방지)
- 동시 워커 6개 → 4개, 파일 간 2초 딜레이로 안정적 순차 처리
- 10~20개 PDF 배치 분석 시에도 안정적 동작

### ⚡ 2. API 호출 최적화
- **소유자 정보 추출**: 4~6회 개별 API 호출 → 1회 통합 호출 (불완전 시 폴백)
- **이미지 페이로드 감소**: Claude 전송 시 PNG → JPEG quality=85 (3~5배 감소)
- Vision Client 레벨에서 Rate Limiter 통합 → 모든 분석기에 자동 적용

### 🎯 3. 34개 검증 규칙 상세 출력
- 모든 검증 규칙의 통과/실패 상태를 개별적으로 표시
- 실패한 규칙의 구체적인 사유 제공
- 통과/실패 개수 집계 표시

### 🔬 4. 시험성적서 정밀 검증
- **열방출시험** 개별 검증 및 표시
- **가스유해성 시험** 개별 검증 및 표시
- 납품확인서 제출 여부 확인
- 외벽 마감재 석재 예외 처리
- 시험성적서가 있는 자재 목록 표시

## 📋 검증 가능한 서류 (34개 규칙)

### 필수 양식
1. 주택매도신청서
2. 매도신청주택 건물·임대현황
3. 개인정보 수집·이용 동의서
4. 청렴서약서
5. 공사직원여부 확인서
6. 위임장 (대리인의 경우)

### 정부 발급 서류
7. 인감증명서
8. 신분증 사본
9. 건축물대장 (표제부, 총괄표제부, 전유부)
10. 건축물현황도
11. 토지대장
12. 토지이용계획확인원
13. 건물 등기부등본
14. 토지 등기부등본

### 기술 서류
15. 준공도면
16. **시험성적서 (열방출시험 + 가스유해성 시험)** ⭐ v5.1 개선
17. 납품확인서

### 기타
18. 중개사무소등록증
19. 사업자등록증 (법인의 경우)
20. 법인 서류

## 🚀 설치 및 실행

### 요구사항
- Python 3.10 이상
- Google Gemini API 키

### 설치
```bash
# 필요한 패키지 설치
pip install -r requirements.txt

# 환경 변수 설정 (.env 파일)
GEMINI_API_KEY=your_api_key_here
```

### 실행
```bash
python main.py
```

## 📖 사용 방법

### 1. 공고문 설정
- "공고문 업로드" 버튼으로 공고문 PDF 파일 업로드
- 또는 저장된 공고문 선택

### 2. 서류 추가
- "파일 추가" 버튼으로 검토할 PDF 파일들 선택
- 여러 파일 동시 선택 가능

### 3. 분석 실행
- "분석 시작" 버튼 클릭
- 최대 4개 파일 동시 분석 (병렬 처리)

### 4. 결과 확인
- **요약 탭**: 전체 판정 및 보완서류 목록
- **상세 결과 탭**: 34개 규칙별 검증 결과
- **시험성적서 검증**: 열방출시험, 가스유해성 시험 개별 확인

## 🎯 검증 결과 예시

```
[ 34개 검증 규칙 상세 결과 ]
----------------------------------------------------------------------
  1. ✅ 주택매도신청서 존재 여부
  2. ✅ 주택 소재지 기재 확인
  ...
 29. ✅ 준공도면 자재 추출
 30. ❌ 시험성적서_납품확인서
      → 필요 항목 미비: 가스유해성 시험 (열전도율 시험 제외)
 31. ✅ 표제부 근생시설 여부
 ...
----------------------------------------------------------------------
통과: 33개 | 보완 필요: 1개

[시험성적서 검증 (규칙 30)]
  ✅ 열방출시험: 포함됨
  ❌ 가스유해성 시험: 미포함 (보완 필요)
  ✅ 납품확인서: 제출됨
  📄 시험성적서 확인된 자재: 폴리우레탄폼
```

## 🔬 시험성적서 검증 상세

### 검증 항목
1. **열방출시험** (필수)
   - 총열방출량 (THR, Total Heat Release)
   - 발열속도 등

2. **가스유해성 시험** (필수)
   - Gas Toxicity
   - 가스독성 시험

3. **납품확인서** (필수)
   - 자재 납품 확인 서류

### 예외 처리
- 외벽 마감재가 **석재**인 경우 시험성적서 생략 가능
- 납품확인서만 필요

### 제외 항목
- ❌ 열전도율 시험 (검증 대상 아님)

## 📊 판정 기준

| 판정 | 설명 | 다음 단계 |
|------|------|----------|
| ✅ 심사가능 | 모든 검증 통과 | 심사 진행 |
| 📝 보완필요 | 일부 서류 미비 | 보완서류 제출 |
| ⚠️ 조건부 | 제외 사유 존재하나 협의 가능 | 검토 후 결정 |
| ❌ 매입제외 | 제외 기준 해당 | 매입 불가 |

## 🛠️ 기술 스택

- **AI 모델**: Google Gemini 2.0 Flash / Anthropic Claude Opus 4.5
- **PDF 처리**: PyMuPDF (fitz)
- **이미지 처리**: Pillow, OpenCV
- **UI**: PySide6 (Qt)
- **데이터 모델**: Pydantic

## 📁 프로젝트 구조

```
AI_Docu_Verifier_v5.2/
├── core/
│   ├── api_rate_limiter.py           # 전역 API Rate Limiter (v5.2 신규)
│   ├── vision_client.py              # Gemini/Claude Vision 공통 인터페이스
│   ├── owner_info_extractor.py       # 소유자 정보 전용 추출기
│   ├── unified_pdf_analyzer.py       # PDF 분석 엔진 (v6.0)
│   ├── enhanced_validation_engine.py # 검증 엔진
│   ├── result_formatter.py           # 결과 포맷터
│   ├── data_models.py                # 데이터 모델
│   ├── exclusion_rules.py            # 제외 규칙
│   ├── integrated_verification.py    # 통합 검증
│   └── ...
├── ui/
│   └── main_window.py                # 메인 UI
├── main.py                           # 실행 파일
├── requirements.txt                  # 패키지 목록
└── README.md                         # 본 파일
```

## 🔍 주요 검증 규칙 (34개)

1. 주택매도신청서 존재 및 작성일
2. 소재지 기재
3. 공고일 이후 작성일
4. 전용면적 합계
5. 임대현황표 제출
6. 임대차계약 정보
7. 위임장 제출 (대리인)
8. 위임장 작성일
9. 개인정보 동의서
10. 청렴서약서
...
29. 준공도면 자재 추출
30. **시험성적서 (열방출+가스유해성) 및 납품확인서** ⭐
31. 근생시설 여부
32. 전유부 최소/최대 면적
33. 등기부 민간임대 명시
34. 토지대장 정보

## ⚙️ 성능 최적화

- **전역 Rate Limiter**: 동시 API 호출 3개 제한, 호출 간격 1.2초, 429 시 30초 쿨다운
- 병렬 처리: 최대 4개 파일 동시 분석, 파일 간 2초 딜레이
- 적응형 DPI: 150~300 DPI 자동 조정
- 이미지 압축: JPEG quality=85 (Claude 전송 시 페이로드 3~5배 감소)
- 소유자 정보 통합 추출: 4~6회 → 1회 API 호출 (불완전 시 개별 폴백)
- 캐시 시스템: 중복 분석 방지

## 📝 버전 이력

### v5.2 (2026-02-07) ⭐ 최신
- ✅ 전역 API Rate Limiter 신설 (다중 PDF 429 에러 해결)
- ✅ Vision Client Rate Limiter 통합 + Claude JPEG 전환
- ✅ 동시 워커 4개 + 파일 간 2초 딜레이
- ✅ 소유자 정보 통합 1회 API 호출 (폴백 포함)
- ✅ 429 발생 시 글로벌 쿨다운 (연쇄 실패 방지)

### v5.1 (2025-02-04)
- ✅ 34개 검증 규칙 상세 출력
- ✅ 시험성적서 정밀 검증 (열방출시험, 가스유해성 시험)
- ✅ 검증 결과 투명성 향상

### v5.0
- 공고문 기반 통합 검증
- 다중 파일 동시 분석
- 통합 검증 시스템

### v4.0
- PDF 분석 엔진 v6.0
- 학습 시스템 도입

## 🐛 알려진 제한사항

1. PDF 스캔 품질에 따라 OCR 정확도 영향
2. 손글씨 인식 제한적
3. 복잡한 도면의 자재명 추출 정확도

## 💡 문제 해결

### 시험성적서가 잘못 인식되는 경우
- PDF 품질 확인 (300 DPI 이상 권장)
- 시험 항목 제목이 명확한지 확인
- 열방출시험, 가스유해성 시험 키워드 포함 여부 확인

### API 오류 (429 Rate Limit) 발생 시
- 전역 Rate Limiter가 자동으로 30초 쿨다운 후 재시도
- GOOGLE_API_KEY 또는 ANTHROPIC_API_KEY 환경 변수 확인
- API 할당량 확인 (Gemini ~60 RPM)
- 네트워크 연결 확인

## 📞 지원

문의사항이나 버그 리포트는 개발팀에 연락해주세요.

---

**Copyright © 2025. All rights reserved.**
