# 버그 수정 보고서 - 2025-02-04

## 수정 개요
다음 3가지 핵심 오류를 수정했습니다:
1. 공고일 파싱 오류
2. 법인 소유자 정보 검증 오류
3. 법인 인감증명서 검증 오류

---

## 1. 공고일 파싱 오류 수정

### 문제
- `announcement_parser.py`의 `_extract_date` 함수가 공고일을 제대로 추출하지 못함
- 단일 정규식 패턴만 사용하여 다양한 형식의 공고문에 대응 불가

### 수정 내용 (`core/announcement_parser.py`, 115-139행)
```python
def _extract_date(self, text: str, date_type: str) -> Optional[str]:
    """날짜 추출"""
    if date_type == "공고":
        # 패턴 1: 문서 끝부분의 공고일 (가장 일반적)
        match = re.search(r"(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})\.\s*$", text, re.MULTILINE)
        if match:
            return f"{match.group(1)}-{match.group(2).zfill(2)}-{match.group(3).zfill(2)}"
        
        # 패턴 2: "공고일" 명시적 표현
        match = re.search(r"공고일?\s*[:：]?\s*(\d{4})[.\s]*(\d{1,2})[.\s]*(\d{1,2})", text)
        if match:
            return f"{match.group(1)}-{match.group(2).zfill(2)}-{match.group(3).zfill(2)}"
        
        # 패턴 3: 문서 제목/첫부분의 날짜
        match = re.search(r"(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일", text[:500])
        if match:
            return f"{match.group(1)}-{match.group(2).zfill(2)}-{match.group(3).zfill(2)}"
```

### 개선 효과
- **다중 패턴 매칭**: 3가지 패턴을 순차적으로 시도하여 추출 성공률 향상
- **우선순위 적용**: 가장 일반적인 패턴부터 시도
- **견고성 향상**: 다양한 형식의 공고문에 대응 가능

---

## 2. 법인 소유자 정보 검증 오류 수정

### 문제
- 법인 소유자의 경우에도 개인정보(성명, 생년월일, 주소, 연락처, 이메일)를 검증
- 법인은 법인등기부등본과 사업자등록증으로 검증해야 하는데 개인정보를 요구
- 결과: "소유자 정보 미기재" 오류 발생

### 수정 내용 (`core/enhanced_validation_engine.py`, 178-231행)
```python
# === 규칙 3: 소유자 정보 완비 ===
# 개선: 법인일 경우 소유자 개인정보 검증 제외
if result.housing_sale_application.exists:
    # 법인 여부 확인
    is_corporate = result.corporate_documents.is_corporation
    
    if not is_corporate:
        # 개인 소유자인 경우에만 개인정보 검증
        owner = result.housing_sale_application.owner_info
        extracted_count = sum([
            bool(owner.name),
            bool(owner.birth_date),
            bool(owner.address),
            bool(owner.phone),
            bool(owner.email),
        ])
        
        # ... 기존 검증 로직 ...
    # 법인인 경우 이 규칙을 건너뜀 (법인 서류로 검증)
```

### 개선 효과
- **법인 예외 처리**: 법인일 경우 개인정보 검증을 건너뜀
- **적절한 검증**: 법인은 규칙15(법인 서류)에서 별도 검증
- **오탐 제거**: 법인인데 개인정보 미기재 오류가 발생하는 문제 해결

---

## 3. 법인 인감증명서 검증 오류 수정

### 문제
- 법인인감증명서가 제출되어 있는데도 "본인발급용 인감증명서 미제출" 오류 발생
- 개인/법인 구분 없이 동일한 인감증명서 검증 로직 적용

### 수정 내용 (`core/enhanced_validation_engine.py`)

#### 3-1. 규칙4 (인감 검증) 수정 (229-257행)
```python
# === 규칙 4: 인감 검증 (45% 이상) ===
# 개선: 법인일 경우 개인 인감증명서 검증 제외
seal = result.housing_sale_application.seal_verification
is_corporate = result.corporate_documents.is_corporation

if result.housing_sale_application.exists and not is_corporate:
    # 개인 소유자인 경우에만 개인 인감 검증
    # ... 기존 검증 로직 ...
# 법인인 경우 개인 인감 검증 건너뜀 (법인인감증명서는 규칙15에서 검증)
```

#### 3-2. 규칙12 (인감증명서) 수정 (362-378행)
```python
# === 규칙 12~14: 신분증/인감증명서 ===
# 개선: 법인인 경우 개인 인감증명서 검증 건너뜀
corp = result.corporate_documents
is_corporate = corp.is_corporation

if not is_corporate:
    # 개인 소유자인 경우에만 개인 인감증명서 검증
    if not result.owner_identity.seal_certificate.exists:
        self._add_supplementary("소유자 인감증명서", "서류 미제출", 12)
    
    if not result.owner_identity.all_ids_submitted:
        self._add_supplementary(
            "소유자 신분증 사본",
            f"소유자 {result.owner_identity.owner_count}명 중 일부 미제출",
            14 if result.owner_identity.owner_count > 1 else 13
        )
```

### 개선 효과
- **정확한 구분**: 개인/법인에 따라 적절한 인감증명서 검증
- **중복 검증 제거**: 법인은 규칙15에서 법인인감증명서를 검증
- **오탐 제거**: 법인인데 개인 인감증명서 미제출 오류가 발생하는 문제 해결

---

## 검증 로직 흐름도

```
┌─────────────────────────────────────┐
│     서류 검증 시작                   │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│ 법인 여부 확인                       │
│ (corporate_documents.is_corporation) │
└─────────────┬───────────────────────┘
              │
        ┌─────┴─────┐
        │           │
    개인 소유자   법인 소유자
        │           │
        ▼           ▼
┌────────────┐ ┌────────────┐
│규칙3: 개인 │ │규칙15: 법인│
│정보 검증   │ │서류 검증   │
│- 성명      │ │- 사업자등록│
│- 생년월일  │ │- 법인등기  │
│- 주소      │ │- 법인인감  │
│- 연락처    │ │- 임원신분증│
│- 이메일    │ └────────────┘
└────────────┘
        │
        ▼
┌────────────┐
│규칙4: 개인 │
│인감 검증   │
│- 일치율45%+│
└────────────┘
        │
        ▼
┌────────────┐
│규칙12: 개인│
│인감증명서  │
└────────────┘
```

---

## 테스트 권장사항

### 테스트 케이스 1: 개인 소유자
- [ ] 공고일이 올바르게 파싱되는지 확인
- [ ] 개인정보(5개 항목) 검증이 작동하는지 확인
- [ ] 개인 인감증명서 검증이 작동하는지 확인

### 테스트 케이스 2: 법인 소유자
- [ ] 공고일이 올바르게 파싱되는지 확인
- [ ] 개인정보 검증이 **건너뛰어지는지** 확인
- [ ] 개인 인감증명서 검증이 **건너뛰어지는지** 확인
- [ ] 법인 서류(사업자등록증, 법인등기, 법인인감) 검증이 작동하는지 확인

### 테스트 케이스 3: 공고일 형식
다음 형식들이 모두 파싱되는지 확인:
- [ ] `2025. 7. 4.` (문서 끝)
- [ ] `공고일: 2025.7.4`
- [ ] `2025년 7월 4일` (문서 첫부분)

---

## 수정 파일 목록
1. `core/announcement_parser.py` (115-139행)
2. `core/enhanced_validation_engine.py` (178-257행, 362-378행)

## 영향 범위
- ✅ 기존 개인 소유자 검증 로직: **영향 없음** (동일하게 작동)
- ✅ 법인 소유자 검증 로직: **개선됨** (오탐 제거)
- ✅ 공고일 파싱: **개선됨** (다양한 형식 지원)

## 하위 호환성
- ✅ 기존 코드와 100% 호환
- ✅ 데이터 모델 변경 없음
- ✅ API 인터페이스 변경 없음
